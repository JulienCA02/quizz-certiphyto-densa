<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz d'entraînement Certiphyto</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #d4f1e5, #b3e5fc);
  color: #333;
  text-align: center;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 800px;
  margin: 50px auto;
  background: white;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  padding: 20px 40px;
}
button {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 12px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s, background 0.3s;
  color: white;
}
button:hover {
  transform: scale(1.05);
}
button.green {background: #43a047;}
button.green:hover {background: #66bb6a;}
button.blue {background: #1e88e5;}
button.blue:hover {background: #42a5f5;}
button.purple {background: #8e24aa;}
button.purple:hover {background: #ab47bc;}
#quiz-container {display: none;}
#result-container {display: none;}
#logo {width: 120px; margin: 20px auto; display: block;}
.option {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  margin: 8px 0;
  cursor: pointer;
  transition: background 0.3s;
}
.option.correct {background-color: #c8e6c9;}
.option.incorrect {background-color: #ffcdd2;}
.hidden {display: none;}
</style>
</head>
<body>
<div class="container" id="start-container">
  <img src="logo.png" id="logo" alt="Logo">
  <h1>Quiz d'entraînement Certiphyto</h1>
  <p>Choisissez votre catégorie :</p>
  <button class="green" onclick="startQuiz('questions-densa-ea.json',30,15,'DENSA-EA - Décideur en entreprise non soumise à agrément - Exploitation agricole')">DENSA-EA<br><small>Décideur en entreprise non soumise à agrément - Exploitation agricole</small></button>
  <button class="green" onclick="startQuiz('questions-densa-col.json',30,15,'DENSA-COL - Décideur en entreprise non soumise à agrément - Collectivité')">DENSA-COL<br><small>Décideur en entreprise non soumise à agrément - Collectivité</small></button>
  <button class="blue" onclick="startQuiz('questions-desa.json',30,20,'DESA - Décideur en entreprise soumise à agrément - Prestation de services du secteur agricole et forestier')">DESA<br><small>Décideur en entreprise soumise à agrément - Prestation de services du secteur agricole et forestier</small></button>
  <button class="purple" onclick="startQuiz('questions-operateur-ea.json',20,12,'Opérateur-EA - Exploitation agricole')">Opérateur-EA<br><small>Opérateur - Exploitation agricole</small></button>
  <button class="purple" onclick="startQuiz('questions-operateur-col.json',20,12,'Opérateur-COL - Collectivité')">Opérateur-COL<br><small>Opérateur - Collectivité</small></button>
</div>

<div class="container" id="quiz-container">
  <h2 id="category-title"></h2>
  <p id="question-number"></p>
  <p id="question-text"></p>
  <div id="options"></div>
  <button id="validate-btn" onclick="validateAnswer()">Valider</button>
  <button onclick="stopQuiz()">Arrêter le quiz</button>
</div>

<div class="container" id="result-container">
  <h2>Résultat</h2>
  <p id="score-text"></p>
  <button onclick="restartQuiz()">Recommencer</button>
  <button onclick="goHome()">Accueil</button>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let score = 0;
let selectedAnswers = [];
let quizLength = 30;
let passingScore = 15;
let categoryTitle = "";
let categoryFile = "";

async function startQuiz(file, length, pass, title) {
  quizLength = length;
  passingScore = pass;
  categoryTitle = title;
  categoryFile = file;
  document.getElementById('category-title').textContent = title;
  document.getElementById('start-container').style.display = 'none';
  document.getElementById('quiz-container').style.display = 'block';

  try {
    const response = await fetch(`${file}?v=${Date.now()}`);
    questions = await response.json();
    shuffle(questions);
    questions = questions.slice(0, quizLength);
    currentQuestionIndex = 0;
    score = 0;
    showQuestion();
  } catch (e) {
    alert("Erreur lors du chargement du quiz.");
  }
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function showQuestion() {
  const q = questions[currentQuestionIndex];
  document.getElementById('question-number').textContent = `Question ${currentQuestionIndex + 1} sur ${quizLength}`;
  document.getElementById('question-text').textContent = q.q;
  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = "";
  selectedAnswers = [];
  q.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.textContent = opt;
    div.classList.add('option');
    div.onclick = () => toggleSelect(div, i);
    optionsDiv.appendChild(div);
  });
  document.getElementById('validate-btn').disabled = false;
}

function toggleSelect(div, index) {
  if (selectedAnswers.includes(index)) {
    selectedAnswers = selectedAnswers.filter(i => i !== index);
    div.style.backgroundColor = '';
  } else {
    selectedAnswers.push(index);
    div.style.backgroundColor = '#bbdefb';
  }
}

function validateAnswer() {
  const q = questions[currentQuestionIndex];
  document.getElementById('validate-btn').disabled = true;
  const optionsDiv = document.getElementById('options');
  const divs = optionsDiv.querySelectorAll('.option');
  let correctSet = new Set(q.answers);
  let isCorrect = true;
  divs.forEach((div, i) => {
    if (correctSet.has(i)) div.classList.add('correct');
    if (selectedAnswers.includes(i) && !correctSet.has(i)) div.classList.add('incorrect');
    if (selectedAnswers.includes(i) !== correctSet.has(i)) isCorrect = false;
  });
  if (isCorrect) score++;
  setTimeout(() => {
    currentQuestionIndex++;
    if (currentQuestionIndex < quizLength) {
      showQuestion();
    } else {
      showResult();
    }
  }, 1500);
}

function stopQuiz() {
  showResult();
}

function showResult() {
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('result-container').style.display = 'block';
  const resultText = `Score : ${score} / ${quizLength}`;
  const success = score >= passingScore;
  document.getElementById('score-text').textContent = resultText + (success ? " ✅ Réussi !" : " ❌ Échoué.");
}

function restartQuiz() {
  document.getElementById('result-container').style.display = 'none';
  startQuiz(categoryFile, quizLength, passingScore, categoryTitle);
}

function goHome() {
  document.getElementById('result-container').style.display = 'none';
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('start-container').style.display = 'block';
}
</script>
</body>
</html>
